<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Crucial Meta Tag: Prevents zooming and ensures correct scaling on phones -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ABI 6TH FORM: THE GAME</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        :root {
            --bg-color: #101015;
            --ui-bg: #ffffff;
            --ui-border: #404040;
            --text-color: #000000;
            --accent: #f0db4f;
            --danger: #ff4444;
            --success: #44ff44;
        }
        body {
            background-color: #050505;
            color: var(--text-color);
            font-family: 'Press Start 2P', cursive;
            margin: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Stops scrolling */
            user-select: none;
            -webkit-user-select: none; /* Crucial for iOS */
            touch-action: none; /* Stops browser handling gestures */
        }

        #game-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        #screen-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
            padding: 10px;
            overflow: hidden;
            position: relative;
        }

        #game-container {
            position: relative;
            aspect-ratio: 4/3;
            width: 100%;
            max-height: 100%;
            max-width: 100vh;
            background-color: var(--bg-color);
            border: 4px solid #333;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            outline: none;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        /* CONTROLS AREA */
        #mobile-controls {
            height: 240px;
            min-height: 35vh;
            background: #222;
            border-top: 4px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            box-sizing: border-box;
            z-index: 1000;
            touch-action: none; /* Critical */
        }

        .dpad {
            display: grid;
            grid-template-columns: 70px 70px 70px;
            grid-template-rows: 70px 70px;
            gap: 5px;
            touch-action: none;
        }
        
        .dpad-btn {
            width: 70px;
            height: 70px;
            background: #444;
            border-bottom: 4px solid #222;
            border-radius: 8px;
            color: #aaa;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            -webkit-user-select: none;
            box-shadow: 0 4px 0 #111;
            cursor: pointer;
            touch-action: none;
        }
        /* When class 'active' is added by JS */
        .dpad-btn.active {
            background: #666;
            transform: translateY(4px);
            box-shadow: 0 0 0 #111;
            border-bottom: none;
        }

        #btn-up { grid-column: 2; grid-row: 1; }
        #btn-left { grid-column: 1; grid-row: 2; }
        #btn-down { grid-column: 2; grid-row: 2; }
        #btn-right { grid-column: 3; grid-row: 2; }

        .action-btn-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #btn-action {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: #d82020;
            border: 4px solid #900;
            box-shadow: 0 6px 0 #500;
            color: white;
            font-size: 24px;
            font-family: 'Press Start 2P', cursive;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            cursor: pointer;
        }
        #btn-action.active {
            transform: translateY(6px);
            box-shadow: 0 0 0 #500;
        }

        /* INTRO & UI */
        #intro-screen {
            position: absolute;
            top:0; left:0; width:100%; height:100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
            color: white;
            overflow: hidden;
        }
        .glitch-title {
            font-size: 30px;
            position: relative;
            color: #44ff44;
            text-shadow: 4px 4px #000;
            margin-bottom: 10px;
            animation: glitch 1s infinite;
        }
        .glitch-title::before, .glitch-title::after {
            content: "ABI 6TH FORM";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%; background: #000;
        }
        .glitch-title::before {
            left: 2px; text-shadow: -2px 0 #ff00c1; clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim-1 5s infinite linear alternate-reverse;
        }
        .glitch-title::after {
            left: -2px; text-shadow: -2px 0 #00fff9; clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim-2 5s infinite linear alternate-reverse;
        }
        @keyframes glitch-anim-1 {
            0% { clip: rect(30px, 9999px, 10px, 0); }
            20% { clip: rect(80px, 9999px, 90px, 0); }
            40% { clip: rect(10px, 9999px, 50px, 0); }
            60% { clip: rect(40px, 9999px, 20px, 0); }
            80% { clip: rect(70px, 9999px, 90px, 0); }
            100% { clip: rect(20px, 9999px, 60px, 0); }
        }
        @keyframes glitch-anim-2 {
            0% { clip: rect(10px, 9999px, 30px, 0); }
            20% { clip: rect(50px, 9999px, 20px, 0); }
            40% { clip: rect(90px, 9999px, 70px, 0); }
            60% { clip: rect(20px, 9999px, 40px, 0); }
            80% { clip: rect(60px, 9999px, 10px, 0); }
            100% { clip: rect(80px, 9999px, 90px, 0); }
        }
        .subtitle { font-size: 10px; color: #ccc; margin-bottom: 20px; letter-spacing: 2px; }
        .mission-box { border: 2px solid #44ff44; padding: 10px; background: rgba(0, 50, 0, 0.8); margin-bottom: 20px; width: 80%; }
        .press-start { font-size: 14px; color: #f0db4f; animation: blinker 0.8s linear infinite; cursor: pointer; }
        @keyframes blinker { 50% { opacity: 0; } }
        
        #focus-overlay {
            position: absolute;
            top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            cursor: pointer;
            color: #4f4;
            flex-direction: column;
            text-align: center;
            touch-action: none;
        }
        #dialogue-box {
            position: absolute; display: none; bottom: 10px; left: 10px; right: 10px; height: 100px; z-index: 10;
            padding: 10px; border: 4px double #000; background-color: #fff; border-radius: 4px; line-height: 1.6; font-size: 12px; color: black;
        }
        #dialogue-name { color: #d00; margin-bottom: 5px; text-transform: uppercase; font-size: 12px; }
        #room-name {
            position: absolute; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.5); padding: 5px 10px; border: 2px solid white; display: none;
        }
        #scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; pointer-events: none; z-index: 999; opacity: 0.3;
        }
        .logo-box {
            border: 4px solid #fff; padding: 15px 20px; background: #000; margin-bottom: 40px; box-shadow: 6px 6px 0px #444;
            display: flex; flex-direction: column; align-items: center; transform: scale(1.2);
        }
        .logo-jbr { font-size: 40px; color: #f0db4f; text-shadow: 4px 4px 0px #d82020; line-height: 1; font-weight: bold; }
        .logo-games { font-size: 12px; color: #44ff44; letter-spacing: 8px; margin-top: 5px; border-top: 2px solid #333; padding-top: 5px; width: 100%; text-align: center; }
    </style>
</head>
<body>
<div id="game-wrapper">
    <div id="screen-area">
        <div id="game-container" tabindex="0">
            <canvas id="gameCanvas" width="800" height="600"></canvas>
            <div id="scanlines"></div>
            <div id="room-name">COMMON ROOM</div>
            
            <div id="focus-overlay">
                <div class="logo-box"><div class="logo-jbr">JBR</div><div class="logo-games">GAMES</div></div>
                <div class="blink" style="color:#f0db4f">Tap to Start</div>
            </div>
            <div id="intro-screen">
                <div class="glitch-title">ABI 6TH FORM</div>
                <div class="subtitle">THE GAME</div>
                <div class="mission-box">
                    <p style="color:#ff4444; margin-bottom:10px;">ALERT: BUG RELEASE</p>
                    <p style="font-size: 8px; line-height: 1.5;">
                        The Main Glitch has stolen the JCQ Exam and AI guidance.<br>
                        You need to recover it so you can spread good practice.<br><br>
                        CONTROLS:<br>Use Buttons Below
                    </p>
                </div>
                <div class="press-start">TAP 'A' BUTTON</div>
            </div>
            <div id="dialogue-box">
                <div id="dialogue-name">System</div><div id="dialogue-text">...</div>
                <div style="font-size: 10px; text-align: right; margin-top: 10px; opacity: 0.7;">[A]</div>
            </div>
        </div>
    </div>
    <div id="mobile-controls">
        <div class="control-group dpad">
            <div class="dpad-btn" id="btn-up">▲</div>
            <div class="dpad-btn" id="btn-left">◀</div>
            <div class="dpad-btn" id="btn-down">▼</div>
            <div class="dpad-btn" id="btn-right">▶</div>
        </div>
        <div class="control-group action-btn-container">
            <div id="btn-action">A</div>
        </div>
    </div>
</div>
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- GLOBAL CONSTANTS ---
const TILE_SIZE = 40;
const COLS = 20;
const ROWS = 15;
const COLORS = { 
    floor: '#222', wall: '#444', 
    mediaFloor: '#203020', libraryFloor: '#202040', examFloor: '#302020' 
};

// --- PIXEL ART SPRITE SYSTEM ---
const PALETTE = {
    '.': null, 'x': '#000000', 's': '#ffccaa', 'w': '#ffffff', 'r': '#d82020',
    'b': '#2040d8', 'g': '#44aa44', 'y': '#ffee00', 'h': '#663300',
    'c': '#888888', 'p': '#aa00aa', 'm': '#00aa00', 'd': '#222222',
    'D': '#664400', 'T': '#8b4513', 'C': '#666666', 'L': '#228b22', 'O': '#ff9900'
};
const SPRITE_DATA = {
    player: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xppppppx.....","..xppppppppx....", ".xppwwwwwwppx...", ".xppwwwwwwppx...", ".xppppppppppx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    grant: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhsxwwxshx....", "..xhsssssshx....", "....xxxxxx......", "...xrrwwrrx.....","..xrrwwwwrrx....", ".xrrwwwwwwrrx...", ".xrrwwwwwwrrx...", ".xrrrrrrrrrrx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    brookes: ["....xxxxxx......", "...xbbbbbbx.....", "..xbbbbbbbbx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhshhhshhx....", "....xxxxxx......", "...xggggggx.....","..xggggggggx....", ".xggccccccggx...", ".xggccccccggx...", ".xggggggggggx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    botwright: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xccccccx.....","..xccwwwwccx....", ".xccwwrrwwccx...", ".xccwwrrwwccx...", ".xccccccccccx...","..xddddddddx....", "..xddddddddx....", "...xx....xx.....", "...xx....xx....."],
    mcmahon: ["....xxxxxx......", "...xyyyyyyx.....", "..xyyyyyyyyx....", "..xyssxxssyx....","..xys.xx.syx....", "..xyssssssyx....", "....xxxxxx......", "...xppppppx.....","..xppppppppx....", ".xppwwwwwwppx...", ".xppwwwwwwppx...", ".xppppppppppx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    oneill: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xbbbbbbx.....","..xbbbbbbbbx....", ".xbbwwwwwwbbx...", ".xbbwwyywwbbx...", ".xbbbbbbbbbbx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    oneill_strict: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xrrrrrrx.....","..xrrrrrrrrx....", ".xrrwwwwwwrrx...", ".xrrwwwwwwrrx...", ".xrrrrrrrrrrx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    julie: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xwwwwwwx.....","..xwwwwwwwwx....", ".xwwwwwwwwwwx...", ".xwwwwwwwwwwx...", ".xwwwwwwwwwwx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    deacon: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xddddddx.....","..xddddddddx....", ".xddddwwddddx...", ".xddddwwddddx...", ".xddddddddddx...","..xddddddddx....", "..xddddddddx....", "...xx....xx.....", "...xx....xx....."],
    jones: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xTTTTTTx.....","..xTTTTTTTTx....", ".xTTTTTTTTTTx...", ".xTTwwwwwwTTx...", ".xTTTTTTTTTTx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    russell: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xwwwwwwx.....","..xwwwwwwwwx....", ".xwwwwwwwwwwx...", ".xwwbbwwbbwwx...", ".xwwwwwwwwwwx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    mckeown: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhsxwwxshx....", "..xhsssssshx....", "....xxxxxx......", "...xppppppx.....","..xppppppppx....", ".xppwwwwwwppx...", ".xppwwwwwwppx...", ".xppppppppppx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    clinton: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xddddddx.....","..xddddddddx....", ".xddddddddddx...", ".xddwwwwwdddx...", ".xddddddddddx...","..xddddddddx....", "..xddddddddx....", "...xx....xx.....", "...xx....xx....."],
    mcdonald: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xyyyyyyx.....","..xyyyyyyyyx....", ".xyywwwwwwyyx...", ".xyywwwwwwyyx...", ".xyyyyyyyyyyx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    lakin: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xbbbbbbx.....","..xbbbbbbbbx....", ".xbbwwwwwwbbx...", ".xbbwwwwwwbbx...", ".xbbbbbbbbbbx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    student: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xbbbbbbx.....","..xbbbbbbbbx....", ".xbbwwwwwwbbx...", ".xbbwwwwwwbbx...", ".xbbbbbbbbbbx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    glitch: ["....mmmmmm......", "...mm.mm.mm.....", "..mmmmmmmmmm....", "..m.m.mm.m.m....","..mmmmmmmmmm....", "..m.mmmmmm.m....", "....mmmmmm......", "...mxmxmxmx.....","..mxmxmxmxmx....", ".xmxmxmxmxmxm...", ".mxmxmxmxmxmx...", ".xmxmxmxmxmxm...","..xmxmxmxmx.....", "..mxmxmxmxm.....", "...m......m.....", "...m......m....."],
    bug: ["................", "................", "................", "................","......mm........", "....mmmmmm......", "...mmxmmxmm.....", "...mmmmmmmm.....","....mmmmmm......", "....m....m......", "....m....m......", "................","................", "................", "................", "................"],
    door: ["xxxxx......xxxxx", "xDDDx......xDDDx", "xDDDx......xDDDx", "xDDDx......xDDDx","xDDDx......xDDDx", "xDDDx......xDDDx", "xDDDx......xDDDx", "xDDDx......xDDDx","xDDDx......xDDDx", "xDDDx......xDDDx", "xDDDx......xDDDx", "xDDDx......xDDDx","xDDDx......xDDDx", "xDDDx......xDDDx", "xDDDx......xDDDx", "xDDDx......xDDDx"],
    chair: ["................", "................", "................", "................","......xxxx......", "......xOOx......", "......xOOx......", "......xOOx......","......xOOx......", "....xxxOOxxx....", "...xOOOOOOOOx...", "...xOOOOOOOOx...","...xOOOOOOOOx...", "...xxxxxxxxxx...", "...x.x....x.x...", "...x.x....x.x..."],
    table: ["................", "................", "................", "................","................", "................", "................", "................",".xxxxxxxxxxxxxx.", ".xTTTTTTTTTTTTx.", ".xTTTTTTTTTTTTx.", ".xTTTTTTTTTTTTx.",".xTTTTTTTTTTTTx.", ".xxxxxxxxxxxxxx.", ".xx..........xx.", ".xx..........xx."],
    plant: ["................", "......LLLL......", "....LLLLLLLL....", "...LLLLLLLLLL...","..LLLLLLLLLLLL..", "..LLLLLLLLLLLL..", "..LLLLLLLLLLLL..", "...LLLLLLLLLL...","....LLLLLLLL....", "......LLLL......", ".......xx.......", "......xDDx......","......xDDx......", "......xDDx......", "......xDDx......", "......xxxx......"],
    alert: ["................", ".......OO.......", "......OOOO......", "......OOOO......","......OOOO......", "......OOOO......", ".......OO.......", ".......OO.......",".......OO.......", "................", ".......OO.......", "......OOOO......",".......OO.......", "................", "................", "................"]
};
function drawSprite(ctx, key, x, y, size, facingRight = true, bob = 0, opacity = 1.0) {
    const data = SPRITE_DATA[key];
    if (!data) return;
    const pixelSize = size / 16;
    const bobOffset = Math.sin(bob) * 2; 
    ctx.globalAlpha = opacity;
    for (let r = 0; r < 16; r++) {
        for (let c = 0; c < 16; c++) {
            let char = data[r][c];
            if (char !== '.') {
                ctx.fillStyle = PALETTE[char];
                let drawX = facingRight ? x + (15 - c) * pixelSize : x + c * pixelSize;
                let drawY = y + r * pixelSize + bobOffset;
                ctx.fillRect(drawX, drawY, pixelSize, pixelSize);
            }
        }
    }
    ctx.globalAlpha = 1.0;
}
function wrapText(context, text, x, y, maxWidth, lineHeight) {
    if (!text) return;
    const words = text.split(' ');
    let line = '';
    for(let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = context.measureText(testLine);
        if (metrics.width > maxWidth && n > 0) {
            context.fillText(line, x, y);
            line = words[n] + ' ';
            y += lineHeight;
        }
        else line = testLine;
    }
    context.fillText(line, x, y);
}
// --- AUDIO SYSTEM ---
let audioCtx, bgmOscillators = [], isMuted = false, currentSong = 'NONE'; 
let battleInit = false, battleLead, battleBass, battleKick, battleNoise, battleLeadSeq, battleBassSeq, battleDrumSeq;
let townInit = false, townSynth, townBass, townMelodySeq, townBassSeq;
let chapelInit = false, chapelSynth, chapelMelodySeq;
let victoryMusicInit = false, victoryMusicSynth, victoryMusicBass, victoryMelodySeq, victoryBassSeq;
let enemyDownInit = false, downNoise, downHit;
let encounterInit = false, encounterSynth;
let victoryInit = false, victorySynth;

function initVictoryFanfare() {
    if (victoryInit) return;
    victorySynth = new Tone.Synth({oscillator:{type:"triangle"},envelope:{attack:0.01,decay:0.1,sustain:0.3,release:0.2}}).toDestination();
    victorySynth.volume.value = -8;
    victoryInit = true;
}
function playVictoryFanfare() {
    if (Tone.context.state !== 'running') return;
    initVictoryFanfare();
    const now = Tone.now();
    const melody = [{note:"C5",time:0,duration:"8n"},{note:"E5",time:0.15,duration:"8n"},{note:"G5",time:0.3,duration:"8n"},{note:"C6",time:0.45,duration:"4n"},{note:"G5",time:0.75,duration:"16n"},{note:"C6",time:0.85,duration:"4n"}];
    melody.forEach(({note, time, duration}) => victorySynth.triggerAttackRelease(note, duration, now + time));
}
function initEncounterSfx() {
  if (encounterInit) return;
  encounterSynth = new Tone.Synth({oscillator:{type:"square"},envelope:{attack:0.001,decay:0.1,sustain:0.3,release:0.1}}).toDestination();
  encounterSynth.volume.value = -8;
  encounterInit = true;
}
function playEncounterSfx() {
  if (Tone.context.state !== 'running') return;
  initEncounterSfx();
  const now = Tone.now();
  const siren = [{note:"E5",time:0},{note:"C5",time:0.15},{note:"E5",time:0.3},{note:"C5",time:0.45},{note:"E5",time:0.6},{note:"C5",time:0.75},{note:"E5",time:0.9},{note:"C5",time:1.05},{note:"G5",time:1.2},{note:"C6",time:1.35}];
  siren.forEach(({note, time}) => encounterSynth.triggerAttackRelease(note, "8n", now + time));
}
function initEnemyDownSfx() {
  if (enemyDownInit) return;
  downNoise = new Tone.NoiseSynth({noise:{type:"white"},envelope:{attack:0.001,decay:0.45,sustain:0}}).toDestination(); downNoise.volume.value = -8;
  downHit = new Tone.Synth({oscillator:{type:"square"},envelope:{attack:0.001,decay:0.2,sustain:0,release:0.1}}).toDestination(); downHit.volume.value = -6;
  enemyDownInit = true;
}
function playEnemyDownSfx() {
  if (Tone.context.state !== 'running') return;
  initEnemyDownSfx();
  const now = Tone.now();
  downNoise.triggerAttackRelease("4n", now);
  ["C3", "G2", "C2"].forEach((n, i) => downHit.triggerAttackRelease(n, "16n", now + 0.15 + i*0.08));
  downHit.triggerAttackRelease("C1", "8n", now + 0.45);
}
async function initAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    try {
        await Tone.start();
        playMusic('ROAM');
    } catch(e) { console.log("Audio init failed", e); }
}
function initTownMusic() {
  if (townInit) return;
  townSynth = new Tone.Synth({oscillator:{type:"triangle"},envelope:{attack:0.02,decay:0.1,sustain:0.3,release:0.5}}).toDestination(); townSynth.volume.value = -10; 
  townBass = new Tone.Synth({oscillator:{type:"square"},envelope:{attack:0.05,decay:0.2,sustain:0.5,release:0.5}}).toDestination(); townBass.volume.value = -8;
  townMelodySeq = new Tone.Sequence((t, n) => n && townSynth.triggerAttackRelease(n, "8n", t), ["C5", null, "E5", "G5", "A5", "G5", "E5", "C5", "D5", null, "F5", "A5", "G5", "F5", "D5", "B4"], "8n");
  townBassSeq = new Tone.Sequence((t, n) => n && townBass.triggerAttackRelease(n, "8n", t), ["C3", null, "C3", null, "F3", null, "F3", null, "G3", null, "G3", null, "C3", null, "C3", null], "4n");
  townMelodySeq.loop = true; townBassSeq.loop = true; townInit = true;
}
function initChapelMusic() {
    if (chapelInit) return;
    chapelSynth = new Tone.PolySynth(Tone.Synth, {oscillator:{type:"sine"},envelope:{attack:0.5,decay:1,sustain:0.8,release:1}}).toDestination(); chapelSynth.volume.value = -12;
    chapelMelodySeq = new Tone.Sequence((t, notes) => { if (notes) chapelSynth.triggerAttackRelease(notes, "2n", t); }, [["C4", "E4", "G4"], null, ["F4", "A4", "C5"], null, ["G4", "B4", "D5"], null, ["C4", "E4", "G4"], null], "2n");
    chapelMelodySeq.loop = true; chapelInit = true;
}
function initVictoryMusic() {
    if (victoryMusicInit) return;
    victoryMusicSynth = new Tone.Synth({oscillator:{type:"triangle"},envelope:{attack:0.01,decay:0.1,sustain:0.4,release:0.3}}).toDestination(); victoryMusicSynth.volume.value = -10;
    victoryMusicBass = new Tone.Synth({oscillator:{type:"square"},envelope:{attack:0.05,decay:0.2,sustain:0.5,release:0.5}}).toDestination(); victoryMusicBass.volume.value = -8;
    victoryMelodySeq = new Tone.Sequence((t, n) => n && victoryMusicSynth.triggerAttackRelease(n, "8n", t), ["C5", "E5", "G5", "C6", "G5", "E5", "C5", "E5", "D5", "F5", "A5", "D6", "A5", "F5", "D5", "F5", "E5", "G5", "C6", "E6", "C6", "G5", "E5", "G5", "C5", "E5", "G5", "C6", null, null, null, null], "8n");
    victoryBassSeq = new Tone.Sequence((t, n) => n && victoryMusicBass.triggerAttackRelease(n, "8n", t), ["C3", "C3", "C3", "C3", "F3", "F3", "F3", "F3", "G3", "G3", "G3", "G3", "C3", "C3", "C3", "C3"], "4n");
    victoryMelodySeq.loop = true; victoryBassSeq.loop = true; victoryMusicInit = true;
}
function initBattleMusic() {
  if (battleInit) return;
  battleLead = new Tone.Synth({oscillator:{type:"square"},envelope:{attack:0.01,decay:0.1,sustain:0.3,release:0.2}}).toDestination(); battleLead.volume.value = -10; 
  battleBass = new Tone.Synth({oscillator:{type:"square"},envelope:{attack:0.01,decay:0.1,sustain:0.4,release:0.2}}).toDestination(); battleBass.volume.value = -8;
  battleKick = new Tone.MembraneSynth().toDestination(); battleKick.volume.value = -6;
  battleNoise = new Tone.NoiseSynth({noise:{type:"white"},envelope:{attack:0.001,decay:0.12,sustain:0}}).toDestination(); battleNoise.volume.value = -12;
  battleBassSeq = new Tone.Sequence((t, n) => n && battleBass.triggerAttackRelease(n, "8n", t), ["C2", "C2", "C2", "C2", "Ab1", "Ab1", "Ab1", "Ab1", "Bb1", "Bb1", "Bb1", "Bb1", "G1", "G1", "G1", "G1"], "8n");
  const leadA = ["C5", null, "Eb5", null, "G5", null, "F5", null, "Eb5", null, "D5", null, "C5", null, null, null];
  const leadB = ["G5", null, "F5", null, "Eb5", null, "C5", null, "Bb4", null, "C5", null, "D5", null, null, null];
  battleLeadSeq = new Tone.Sequence((t, n) => n && battleLead.triggerAttackRelease(n, "16n", t), [...leadA,...leadA,...leadB,...leadA], "16n");
  battleDrumSeq = new Tone.Sequence((t, h) => { if (h === "K") battleKick.triggerAttackRelease("C1", "16n", t); }, ["K", null, null, null, "K", null, null, null, "K", null, null, null, "K", null, null, null], "16n");
  battleBassSeq.loop = true; battleLeadSeq.loop = true; battleDrumSeq.loop = true; battleInit = true;
}
function stopAllMusic() {
    if (battleBassSeq) { battleBassSeq.dispose(); battleBassSeq = null; } if (battleLeadSeq) { battleLeadSeq.dispose(); battleLeadSeq = null; } if (battleDrumSeq) { battleDrumSeq.dispose(); battleDrumSeq = null; }
    if (battleLead) { battleLead.dispose(); battleLead = null; } if (battleBass) { battleBass.dispose(); battleBass = null; } if (battleKick) { battleKick.dispose(); battleKick = null; } if (battleNoise) { battleNoise.dispose(); battleNoise = null; }
    battleInit = false;
    if (townMelodySeq) { townMelodySeq.dispose(); townMelodySeq = null; } if (townBassSeq) { townBassSeq.dispose(); townBassSeq = null; } if (townSynth) { townSynth.dispose(); townSynth = null; } if (townBass) { townBass.dispose(); townBass = null; }
    townInit = false;
    if (chapelMelodySeq) { chapelMelodySeq.dispose(); chapelMelodySeq = null; } if (chapelSynth) { chapelSynth.dispose(); chapelSynth = null; }
    chapelInit = false;
    if (victoryMelodySeq) { victoryMelodySeq.dispose(); victoryMelodySeq = null; } if (victoryBassSeq) { victoryBassSeq.dispose(); victoryBassSeq = null; } if (victoryMusicSynth) { victoryMusicSynth.dispose(); victoryMusicSynth = null; } if (victoryMusicBass) { victoryMusicBass.dispose(); victoryMusicBass = null; }
    victoryMusicInit = false;
    try { Tone.Transport.stop(); Tone.Transport.cancel(); Tone.Transport.position = 0; } catch(e) { console.log("Error stopping transport:", e); }
    currentSong = 'NONE';
}
async function startBattleMusic() { if (Tone.context.state !== 'running') await Tone.start(); Tone.Transport.bpm.value = 150; initBattleMusic(); battleBassSeq.start(0); battleLeadSeq.start(0); battleDrumSeq.start(0); Tone.Transport.start(); }
async function startTownMusic() { if (Tone.context.state !== 'running') await Tone.start(); Tone.Transport.bpm.value = 120; initTownMusic(); townMelodySeq.start(0); townBassSeq.start(0); Tone.Transport.start(); }
async function startChapelMusic() { if (Tone.context.state !== 'running') await Tone.start(); Tone.Transport.bpm.value = 80; initChapelMusic(); chapelMelodySeq.start(0); Tone.Transport.start(); }
async function startVictoryMusic() { if (Tone.context.state !== 'running') await Tone.start(); Tone.Transport.bpm.value = 140; initVictoryMusic(); victoryMelodySeq.start(0); victoryBassSeq.start(0); Tone.Transport.start(); }
function playMusic(track) {
    if (currentSong === track) return;
    stopAllMusic(); currentSong = track;
    if (track === 'BATTLE') startBattleMusic(); else if (track === 'ROAM') startTownMusic(); else if (track === 'CHAPEL') startChapelMusic(); else if (track === 'WIN') startVictoryMusic();
}
function playSound(type) {
    if (isMuted) return;
    if(Tone && Tone.context.state === 'running') {
        const synth = new Tone.Synth().toDestination(); const noise = new Tone.NoiseSynth().toDestination();
        if (type === 'SELECT') synth.triggerAttackRelease("C6", "32n"); if (type === 'CORRECT') synth.triggerAttackRelease("E6", "16n");
        if (type === 'WRONG') { noise.noise.type = 'pink'; noise.triggerAttackRelease("8n"); } if (type === 'HIT') { noise.noise.type = 'white'; noise.triggerAttackRelease("16n"); }
        if (type === 'ALERT') synth.triggerAttackRelease("C7", "32n");
    }
}
const MAP_LAYOUTS = {
    'COMMON_ROOM': {
        name: "COMMON ROOM (HUB)", color: '#333344',
        data: [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,5,0,0,0,0,0,4,3,3,4,0,0,0,0,0,0,0,5,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,4,3,4,0,0,0,0,0,0,0,4,3,4,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,4,3,3,4,0,0,4,3,3,4,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,4,3,4,0,0,0,0,0,0,0,4,3,4,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        npcs: [
            { id: 'mcmahon_intro', name: 'Mrs McMahon', role: 'Teacher', spriteKey: 'oneill', color: '#5555ff', gridX: 10, gridY: 3, dialogue: ["Improper use of AI is sweeping Archbishop Ilsley.", "The bugs have locked Mrs Grant in her office with a Glitch.", "You need to help the school by destroying three bugs to unlock her office then fight the Glitch.", "Good Luck."] },
            { id: 'clinton', name: 'Mr Clinton', role: 'Head Teacher', spriteKey: 'clinton', color: '#333333', gridX: 5, gridY: 5, dialogue: ["I am Mr Clinton, the head teacher.", "We have some bugs."] },
            { id: 'oneill_strict_cr', name: 'Mrs O\'Neill', role: 'Head of Behaviour', spriteKey: 'oneill_strict', color: '#ff0000', gridX: 15, gridY: 8, dialogue: [], autoInteract: true, damage: 10, messages: ["You are being too loud!", "I told you to get to lesson!"] },
            { id: 'brookes', name: 'Mr Brookes', role: 'Media & Film', spriteKey: 'brookes', color: '#44aa44', gridX: 2, gridY: 5, dialogue: ["*SIGH* I told them we needed more AI and Media Literacy training...", "But would they listen... No!", "Anyways, you might want to avoid Ms O'Neill.", "If you need some health points, visit the canteen or chapel."] }
        ],
        minions: [],
        doors: [{ x: 9, y: 13, target: 'CORRIDOR', targetX: 9, targetY: 2 }, { x: 10, y: 13, target: 'CORRIDOR', targetX: 10, targetY: 2 }],
        crowd: []
    },
    'CORRIDOR': {
        name: "MAIN CORRIDOR", color: '#222222',
        data: [[1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        npcs: [
            { id: 'botwright', name: 'Mr Botwright', role: 'Tutor', spriteKey: 'botwright', color: '#5555ff', gridX: 12, gridY: 8, dialogue: ["Lots of kids in the corridor today, they must be looking for the glitch!"] },
            { id: 'oneill_strict', name: 'Mrs O\'Neill', role: 'Head of Behaviour', spriteKey: 'oneill_strict', color: '#ff0000', gridX: 5, gridY: 6, dialogue: [], autoInteract: true, damage: 10, messages: ["You are being too loud!", "I told you to get to lesson!"] },
            { id: 'foley', name: 'Mr Foley', role: 'Teacher', spriteKey: 'clinton', color: '#00aaaa', gridX: 8, gridY: 4, dialogue: ["Come on now, walk with purpose, every minute matters!"] }
        ],
        minions: [],
        doors: [{ x: 9, y: 0, target: 'COMMON_ROOM', targetX: 9, targetY: 12 }, { x: 10, y: 0, target: 'COMMON_ROOM', targetX: 10, targetY: 12 }, { x: 19, y: 3, target: 'CANTEEN', targetX: 2, targetY: 7 }, { x: 0, y: 5, target: 'CHAPEL', targetX: 18, targetY: 7 }, { x: 9, y: 13, target: 'CLASSROOM_HALL', targetX: 9, targetY: 1 }, { x: 10, y: 13, target: 'CLASSROOM_HALL', targetX: 10, targetY: 1 }],
        crowd: [{ gridX: 4, gridY: 3, spriteKey: 'student', facingRight: true }, { gridX: 16, gridY: 4, spriteKey: 'student', facingRight: false }, { gridX: 8, gridY: 10, spriteKey: 'student', facingRight: true }, { gridX: 14, gridY: 11, spriteKey: 'student', facingRight: false }, { gridX: 2, gridY: 7, spriteKey: 'student', facingRight: true }, { gridX: 18, gridY: 6, spriteKey: 'student', facingRight: false }]
    },
    'CANTEEN': {
        name: "THE CANTEEN", color: '#302020',
        data: [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,3,3,3,3,0,0,3,3,3,3,0,0,3,3,3,3,0,0,1],[1,4,4,4,4,0,0,4,4,4,4,0,0,4,4,4,4,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,3,3,3,3,0,0,3,3,3,3,0,0,3,3,3,3,0,0,1],[1,4,4,4,4,0,0,4,4,4,4,0,0,4,4,4,4,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,6,6,6,6,6,6,6,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        npcs: [
            { id: 'julie', name: 'Julie', role: 'Canteen Staff', spriteKey: 'julie', color: '#ffffff', gridX: 10, gridY: 11, dialogue: ["Hi love! Need a break?", "Here, have a hot meal. It's on the house."], heal: true },
            { id: 'student_chicken', name: 'Student', role: 'Year 12', spriteKey: 'student', color: '#ddddff', gridX: 8, gridY: 10, dialogue: ["Do the bugs know it is Chicken Burger day?"] },
            { id: 'mcdonald', name: 'Mr McDonald', role: 'Teacher', spriteKey: 'mcdonald', color: '#ffff00', gridX: 5, gridY: 8, dialogue: ["I am on duty. I hope the bugs do not mess with Bromcom today"] },
            { id: 'lakin', name: 'Mr Lakin', role: 'Teacher', spriteKey: 'lakin', color: '#8888ff', gridX: 15, gridY: 8, dialogue: ["The glitch best not break the laser cutter."] }
        ],
        minions: [],
        doors: [{ x: 0, y: 7, target: 'CORRIDOR', targetX: 18, targetY: 3 }],
        crowd: [{ gridX: 2, gridY: 4, spriteKey: 'student', facingRight: true, static: true }, { gridX: 14, gridY: 4, spriteKey: 'student', facingRight: false, static: true }]
    },
    'CHAPEL': {
        name: "THE CHAPEL", color: '#202040',
        data: [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,6,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,4,4,4,4,0,0,0,0,0,4,4,4,4,0,0,0,1],[1,0,0,4,4,4,4,0,0,0,0,0,4,4,4,4,0,0,0,1],[1,0,0,4,4,4,4,0,0,0,0,0,4,4,4,4,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,4,4,4,4,0,0,0,0,0,4,4,4,4,0,0,0,1],[1,0,0,4,4,4,4,0,0,0,0,0,4,4,4,4,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        npcs: [
            { id: 'deacon', name: 'Deacon Martin', role: 'Chaplain', spriteKey: 'deacon', color: '#aaaaaa', gridX: 9, gridY: 2, dialogue: ["Peace be with you.", "Let me heal your weary soul."], heal: true },
            { id: 'student_praying', name: 'Student', role: 'Year 13', spriteKey: 'student', color: '#ddddff', gridX: 12, gridY: 4, dialogue: ["Please let the bugs go away...", "Amen."] }
        ],
        minions: [],
        doors: [{ x: 19, y: 7, target: 'CORRIDOR', targetX: 1, targetY: 5 }],
        crowd: [{ gridX: 4, gridY: 4, spriteKey: 'student', facingRight: true, static: true }, { gridX: 4, gridY: 10, spriteKey: 'student', facingRight: true, static: true }]
    },
    'CLASSROOM_HALL': {
        name: "LOWER CORRIDOR", color: '#222222',
        data: [[1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[2,0,0,0,0,0,2,0,0,0,0,0,2,0,0,0,0,0,0,2],[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,1],[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,1],[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],
        npcs: [{ id: 'oneill_strict_ch', name: 'Mrs O\'Neill', role: 'Head of Behaviour', spriteKey: 'oneill_strict', color: '#ff0000', gridX: 3, gridY: 3, dialogue: [], autoInteract: true, damage: 10, messages: ["You are being too loud!", "I told you to get to lesson!"] }],
        minions: [],
        doors: [{ x: 9, y: 0, target: 'CORRIDOR', targetX: 9, targetY: 12 }, { x: 10, y: 0, target: 'CORRIDOR', targetX: 10, targetY: 12 }, { x: 0, y: 4, target: 'CLASSROOM_1', targetX: 18, targetY: 7 }, { x: 6, y: 4, target: 'CLASSROOM_2', targetX: 9, targetY: 13 }, { x: 12, y: 4, target: 'CLASSROOM_3', targetX: 9, targetY: 13 }, { x: 19, y: 4, target: 'OFFICE', targetX: 1, targetY: 7 }],
        crowd: []
    },
    'CLASSROOM_1': {
        name: "CLASSROOM 1", color: '#252525',
        data: [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,3,3,0,3,3,0,3,3,0,3,3,0,0,0,0,0,0,0,1],[1,4,4,0,4,4,0,4,4,0,4,4,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,3,3,0,3,3,0,3,3,0,3,3,0,0,0,0,0,0,0,1],[1,4,4,0,4,4,0,4,4,0,4,4,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        npcs: [{ id: 'jones', name: 'Mr Jones', role: 'History', spriteKey: 'jones', color: '#aaffaa', gridX: 15, gridY: 2, dialogue: ["AI keeps hallucinating facts about the Tudors.", "I need real sources!"] }],
        minions: [{gridX:5,gridY:5,spriteKey:'bug',active:true}], doors: [{x:19,y:7,target:'CLASSROOM_HALL',targetX:1,targetY:4}],
        crowd: [{ gridX: 2, gridY: 4, spriteKey: 'student', facingRight: true, static: true }, { gridX: 5, gridY: 4, spriteKey: 'student', facingRight: true, static: true }, { gridX: 8, gridY: 10, spriteKey: 'student', facingRight: true, static: true }]
    },
    'CLASSROOM_2': {
        name: "CLASSROOM 2", color: '#252525',
        data: [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,3,3,0,3,3,0,3,3,0,3,3,0,0,0,0,0,0,0,1],[1,4,4,0,4,4,0,4,4,0,4,4,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,3,3,0,3,3,0,3,3,0,3,3,0,0,0,0,0,0,0,1],[1,4,4,0,4,4,0,4,4,0,4,4,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        npcs: [{ id: 'russell', name: 'Miss Russell', role: 'Science', spriteKey: 'russell', color: '#aaaaff', gridX: 2, gridY: 2, dialogue: ["Data must be verified.", "Don't let AI make up your results."] }],
        minions: [{gridX:10,gridY:8,spriteKey:'bug',active:true}], doors: [{x:9,y:13,target:'CLASSROOM_HALL',targetX:6,targetY:5}],
        crowd: [{ gridX: 4, gridY: 4, spriteKey: 'student', facingRight: true, static: true }, { gridX: 10, gridY: 4, spriteKey: 'student', facingRight: true, static: true }, { gridX: 2, gridY: 10, spriteKey: 'student', facingRight: true, static: true }]
    },
    'CLASSROOM_3': {
        name: "CLASSROOM 3", color: '#252525',
        data: [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,3,3,0,3,3,0,3,3,0,3,3,0,0,0,0,0,0,0,1],[1,4,4,0,4,4,0,4,4,0,4,4,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,3,3,0,3,3,0,3,3,0,3,3,0,0,0,0,0,0,0,1],[1,4,4,0,4,4,0,4,4,0,4,4,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        npcs: [{ id: 'mckeown', name: 'Mrs McKeown', role: 'English', spriteKey: 'mckeown', color: '#ffaaaa', gridX: 15, gridY: 2, dialogue: ["Where is your voice?", "This essay sounds like a robot wrote it."] }],
        minions: [{gridX:14,gridY:5,spriteKey:'bug',active:true}], doors: [{x:9,y:13,target:'CLASSROOM_HALL',targetX:12,targetY:5}],
        crowd: [{ gridX: 1, gridY: 4, spriteKey: 'student', facingRight: true, static: true }, { gridX: 7, gridY: 4, spriteKey: 'student', facingRight: true, static: true }, { gridX: 5, gridY: 10, spriteKey: 'student', facingRight: true, static: true }]
    },
    'OFFICE': {
        name: "MRS GRANT'S OFFICE", color: '#301010',
        data: [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,6,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        npcs: [{ id: 'grant_final', name: 'Mrs Grant', role: 'Head of Sixth Form', spriteKey: 'grant', color: '#ff5555', gridX: 16, gridY: 7, dialogue: ["The Main Glitch is right there!", "Defeat it to recover the JCQ Guidance data!"] }],
        minions: [],
        doors: [{ x: 0, y: 7, target: 'CLASSROOM_HALL', targetX: 18, targetY: 4 }],
        boss: { active: true, gridX: 9, gridY: 5, spriteKey: 'glitch', hp: 200 },
        crowd: []
    }
};
const STATE = { INTRO: 0, ROAM: 1, DIALOGUE: 2, BATTLE: 3, GAMEOVER: 4, WIN: 5, TRANSITION: 6 };
let currentState = STATE.INTRO;
let frames = 0;
let winTimer = 0; 
let transitionTimer = 0; 
let introCutsceneActive = false;
let introCutsceneFinished = false;
let officeCutsceneActive = false; 
let officeCutscenePlayed = false; 

const player = { 
    gridX: 10, gridY: 7, x: 400, y: 280, targetX: 400, targetY: 280, isMoving: false, facingRight: true, bobFrame: 0,
    hp: 100, maxHp: 100, auth: 100, maxAuth: 100, spriteKey: 'player', inventory: [], interactionCooldown: 0, autoInteractCooldown: 0, currentRoom: 'COMMON_ROOM'
};
let activeRoom = MAP_LAYOUTS['COMMON_ROOM'];
let activeMap = activeRoom.data;
let activeNPCs = activeRoom.npcs;
let activeMinions = activeRoom.minions;
let activeCrowd = activeRoom.crowd || [];
let activeBoss = null;

activeNPCs.forEach(n => { n.pixelX = n.gridX * TILE_SIZE; n.pixelY = n.gridY * TILE_SIZE; n.targetPixelX = n.pixelX; n.targetPixelY = n.pixelY; n.isMoving = false; });

let battleState = 'MENU';
let battleTurn = 'PLAYER';
let activeBattleEnemy = {};
let battleMenuIdx = 0;
let battleMsg = "";
let battleEffects = [];
let battleShake = 0;
let matrixRain = [];
let currentQuestion = null;
let selectedOptionIdx = 0;
let pendingAction = ''; 

const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, " ": false };
let keyProcessed = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, " ": false };

window.addEventListener('keydown', e => { if(keys.hasOwnProperty(e.key) || e.key === " ") { keys[e.key] = true; } });
window.addEventListener('keyup', e => { if(keys.hasOwnProperty(e.key) || e.key === " ") { keys[e.key] = false; keyProcessed[e.key] = false; } });

// --- DIALOGUE FUNCTIONS (MOVED UP TO FIX REFERENCE ERROR) ---
let dialogueQueue = []; let dialogueSpeaker = "";
function startDialogue(npc) {
    if (player.interactionCooldown > 0) return;
    playSound('SELECT');
    dialogueQueue = [...npc.dialogue];
    if (npc.heal) dialogueQueue.push("[HP RESTORED]");
    
    dialogueSpeaker = npc.name;
    currentState = STATE.DIALOGUE;
    document.getElementById('dialogue-box').style.display = 'block';
    document.getElementById('dialogue-name').innerText = dialogueSpeaker;
    document.getElementById('dialogue-text').innerText = dialogueQueue[0];
    player.interactionCooldown = 15;
}
function advanceDialogue() {
    dialogueQueue.shift();
    if (dialogueQueue.length === 0) { currentState = STATE.ROAM; document.getElementById('dialogue-box').style.display = 'none'; player.interactionCooldown = 20; }
    else { document.getElementById('dialogue-text').innerText = dialogueQueue[0]; player.interactionCooldown = 15; }
}

// --- MATRIX RAIN (MOVED HERE) ---
function initMatrixRain() {
    matrixRain = [];
    for(let i=0; i<50; i++) {
        matrixRain.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, speed: Math.random() * 5 + 2, chars: "101010 AI ERROR JCQ" });
    }
}
initMatrixRain();

// --- INPUT AND ROOM LOGIC ---
function setupMobileControls() {
    const btnUp = document.getElementById('btn-up');
    const btnDown = document.getElementById('btn-down');
    const btnLeft = document.getElementById('btn-left');
    const btnRight = document.getElementById('btn-right');
    const btnAction = document.getElementById('btn-action');
    const handleTouch = (key, pressed) => { if (pressed) { keys[key] = true; } else { keys[key] = false; keyProcessed[key] = false; } };
    const addBtnListener = (btn, key) => {
        if(!btn) return;
        const start = (e) => { e.preventDefault(); handleTouch(key, true); btn.classList.add('active'); };
        const end = (e) => { e.preventDefault(); handleTouch(key, false); btn.classList.remove('active'); };
        btn.addEventListener('touchstart', start, {passive: false}); btn.addEventListener('touchend', end, {passive: false});
        btn.addEventListener('mousedown', start); btn.addEventListener('mouseup', end); btn.addEventListener('mouseleave', end);
    };
    addBtnListener(btnUp, 'ArrowUp'); addBtnListener(btnDown, 'ArrowDown'); addBtnListener(btnLeft, 'ArrowLeft'); addBtnListener(btnRight, 'ArrowRight'); addBtnListener(btnAction, ' ');
    const overlay = document.getElementById('focus-overlay');
    if(overlay) {
        const startAudio = (e) => { e.preventDefault(); initAudio(); overlay.style.display='none'; document.getElementById('game-container').focus(); };
        overlay.addEventListener('touchstart', startAudio, {passive: false}); overlay.addEventListener('click', startAudio);
    }
}
setupMobileControls();

function switchRoom(roomKey, startX, startY) {
    if (!MAP_LAYOUTS[roomKey]) { console.error("INVALID ROOM KEY:", roomKey); return false; }
    const previousRoom = player.currentRoom;
    if (roomKey === 'OFFICE') {
        const c1Cleared = MAP_LAYOUTS['CLASSROOM_1'].minions.every(m => !m.active);
        const c2Cleared = MAP_LAYOUTS['CLASSROOM_2'].minions.every(m => !m.active);
        const c3Cleared = MAP_LAYOUTS['CLASSROOM_3'].minions.every(m => !m.active);
        if (!c1Cleared || !c2Cleared || !c3Cleared) {
            playSound('ALERT');
            const status = `C1: ${c1Cleared ? '✓' : ' ✗ '} | C2: ${c2Cleared ? '✓' : ' ✗ '} | C3: ${c3Cleared ? '✓' : ' ✗ '}`;
            startDialogue({ name: 'SECURITY SYSTEM', role: 'LOCKDOWN', color: '#ff0000', dialogue: [">>> ACCESS DENIED <<<", "You must clear the bugs in ALL 3 Classrooms first.", status], heal: false });
            return false; 
        }
        if (!officeCutscenePlayed) { officeCutsceneActive = true; }
    }
    player.currentRoom = roomKey; activeRoom = MAP_LAYOUTS[roomKey]; activeMap = activeRoom.data; activeNPCs = activeRoom.npcs; activeMinions = activeRoom.minions; activeCrowd = activeRoom.crowd || []; activeBoss = activeRoom.boss || null;
    
    const initEntity = (e) => { e.pixelX = e.gridX * TILE_SIZE; e.pixelY = e.gridY * TILE_SIZE; e.targetPixelX = e.pixelX; e.targetPixelY = e.pixelY; e.isMoving = false; };
    activeCrowd.forEach(initEntity); activeNPCs.forEach(initEntity);
    
    player.gridX = startX; player.gridY = startY; player.x = startX * TILE_SIZE; player.y = startY * TILE_SIZE; player.targetX = player.x; player.targetY = player.y;
    document.getElementById('room-name').innerText = activeRoom.name; document.getElementById('room-name').style.display = 'block'; setTimeout(() => document.getElementById('room-name').style.display = 'none', 2000);
    if (roomKey === 'CHAPEL') playMusic('CHAPEL'); else if (previousRoom === 'CHAPEL') playMusic('ROAM');
    return true;
}
function tryMove(dx, dy) {
    if (player.isMoving) return;
    const nextX = player.gridX + dx; const nextY = player.gridY + dy;
    if (nextX < 0 || nextX >= COLS || nextY < 0 || nextY >= ROWS) return;
    const tile = activeMap[nextY][nextX];
    if (tile === 1 || (tile >= 3 && tile <= 6)) return; 
    for(let i=0; i<activeMinions.length; i++) { let m = activeMinions[i]; if (m.active && m.gridX === nextX && m.gridY === nextY) { startBattle('minion', i); return; } }
    if (activeBoss && activeBoss.active && activeBoss.gridX === nextX && activeBoss.gridY === nextY) { startBattle('boss', -1); return; }
    for (let door of activeRoom.doors) { if (door.x === nextX && door.y === nextY) { if(!switchRoom(door.target, door.targetX, door.targetY)) {} return; } }
    for(let npc of activeNPCs) { if (npc.gridX === nextX && npc.gridY === nextY) return; }
    player.gridX = nextX; player.gridY = nextY; player.targetX = nextX * TILE_SIZE; player.targetY = nextY * TILE_SIZE; player.isMoving = true; player.bobFrame = 0;
    if (dx > 0) player.facingRight = true; if (dx < 0) player.facingRight = false;
}
function update() {
    frames++;
    if (currentState === STATE.INTRO) {
        if (keys[" "] && !keyProcessed[" "]) { keyProcessed[" "] = true; currentState = STATE.ROAM; player.interactionCooldown = 20; document.getElementById('intro-screen').style.display = 'none'; if (!introCutsceneFinished) introCutsceneActive = true; }
        return;
    }
    if (currentState === STATE.TRANSITION) { transitionTimer--; if (transitionTimer <= 0) { currentState = STATE.BATTLE; setTimeout(() => { playMusic('BATTLE'); }, 100); } return; }
    if (currentState === STATE.WIN) { winTimer++; }
    if (currentState === STATE.ROAM) {
        if (player.interactionCooldown > 0) player.interactionCooldown--;
        if (player.autoInteractCooldown > 0) player.autoInteractCooldown--;
        
        const handleEntityMove = (p, isNpc) => {
            if (p.static) return;
            if (p.isMoving) {
                const speed = 2; const dx = p.targetPixelX - p.pixelX; const dy = p.targetPixelY - p.pixelY;
                if (Math.abs(dx) <= speed && Math.abs(dy) <= speed) { p.pixelX = p.targetPixelX; p.pixelY = p.targetPixelY; p.isMoving = false; } else { p.pixelX += Math.sign(dx) * speed; p.pixelY += Math.sign(dy) * speed; }
            } else if ((isNpc && p.spriteKey === 'oneill_strict' && Math.random() < 0.03) || (!isNpc && Math.random() < 0.02)) { 
                const dir = Math.floor(Math.random() * 4); let dx = 0, dy = 0; if (dir===0) dy=-1; else if(dir===1) dy=1; else if(dir===2) dx=-1; else dx=1;
                const nx = p.gridX + dx; const ny = p.gridY + dy;
                if (nx >= 0 && nx < COLS && ny >= 0 && ny < ROWS) {
                    const t = activeMap[ny][nx];
                    if (t === 0 && !(nx===player.gridX && ny===player.gridY)) {
                         let hitNPC = activeNPCs.some(n => n.gridX === nx && n.gridY === ny);
                         let hitCrowd = activeCrowd.some(c => c !== p && c.gridX === nx && c.gridY === ny);
                         if (!hitNPC && !hitCrowd) { p.gridX = nx; p.gridY = ny; p.targetPixelX = nx * TILE_SIZE; p.targetPixelY = ny * TILE_SIZE; p.isMoving = true; p.facingRight = dx > 0; }
                    }
                }
            }
        };
        activeCrowd.forEach(p => handleEntityMove(p, false));
        activeNPCs.forEach(n => { if (n.spriteKey === 'oneill_strict') handleEntityMove(n, true); });

        if (introCutsceneActive) {
            if (!player.isMoving) { if (player.gridY > 4) { tryMove(0, -1); } else { introCutsceneActive = false; introCutsceneFinished = true; player.facingRight = true; const npc = activeNPCs.find(n => n.id === 'mcmahon_intro'); if(npc) { player.interactionCooldown = 0; startDialogue(npc); } } }
        } else if (officeCutsceneActive) {
            const grant = activeNPCs.find(n => n.id === 'grant_final');
            if (grant) {
                const dist = Math.abs(grant.gridX - player.gridX);
                if (dist > 2) { if (!grant.isMoving) { grant.gridX -= 1; grant.targetPixelX = grant.gridX * TILE_SIZE; grant.isMoving = true; grant.facingRight = false; } } 
                else if (!grant.isMoving) { officeCutsceneActive = false; officeCutscenePlayed = true; player.interactionCooldown = 0; startDialogue({ name: grant.name, role: grant.role, color: grant.color, dialogue: ["Thank you for unlocking the door.", "The bugs have been terrible.", "I know you will know the answers to defeat the glitch.", "I believe in you!"] }); }
            } else { officeCutsceneActive = false; }
        } else if (player.autoInteractCooldown === 0 && !player.isMoving) {
            const adj = [{x: player.gridX, y: player.gridY - 1}, {x: player.gridX, y: player.gridY + 1}, {x: player.gridX - 1, y: player.gridY}, {x: player.gridX + 1, y: player.gridY}, {x: player.gridX, y: player.gridY}];
            for (let pos of adj) { for (let npc of activeNPCs) { if (npc.autoInteract && npc.gridX === pos.x && npc.gridY === pos.y) { const msg = npc.messages[Math.floor(Math.random() * npc.messages.length)]; player.hp -= npc.damage; playSound('ALERT'); if (player.hp <= 0) { loseGame("Caught by Mrs O'Neill!"); return; } startDialogue({ name: npc.name, role: npc.role, color: npc.color, dialogue: [msg, `[-${npc.damage} HP]`] }); player.autoInteractCooldown = 180; break; } } }
        }
        if (player.isMoving) {
            const speed = 4; const dx = player.targetX - player.x; const dy = player.targetY - player.y;
            if (Math.abs(dx) <= speed && Math.abs(dy) <= speed) { player.x = player.targetX; player.y = player.targetY; player.isMoving = false; } else { player.x += Math.sign(dx) * speed; player.y += Math.sign(dy) * speed; player.bobFrame += 0.2; }
        } else if (!introCutsceneActive && !officeCutsceneActive) {
            if (keys.ArrowUp) tryMove(0, -1); else if (keys.ArrowDown) tryMove(0, 1); else if (keys.ArrowLeft) tryMove(-1, 0); else if (keys.ArrowRight) tryMove(1, 0);
        }
        if (keys[" "] && !keyProcessed[" "] && !player.isMoving && player.interactionCooldown === 0 && !introCutsceneActive && !officeCutsceneActive) {
            keyProcessed[" "] = true; let interact = false;
            const adj = [{x: player.gridX, y: player.gridY - 1}, {x: player.gridX, y: player.gridY + 1}, {x: player.gridX - 1, y: player.gridY}, {x: player.gridX + 1, y: player.gridY}];
            for (let pos of adj) { for (let npc of activeNPCs) { if (npc.gridX === pos.x && npc.gridY === pos.y) { if (npc.heal) player.hp = player.maxHp; startDialogue(npc); interact = true; break; } } if (interact) break; }
        }
    }
    if (currentState === STATE.DIALOGUE) { if (keys[" "] && !keyProcessed[" "] && player.interactionCooldown === 0) { keyProcessed[" "] = true; advanceDialogue(); } if (player.interactionCooldown > 0) player.interactionCooldown--; }
    if (currentState === STATE.BATTLE) updateBattle();
}

function startBattle(type, index) {
    playEncounterSfx(); // Play encounter alarm!
    currentState = STATE.TRANSITION; // Wipe effect first
    transitionTimer = 90; // frames (increased for longer siren)
    battleState = 'MENU';
    battleTurn = 'PLAYER';
    battleMenuIdx = 0;
    initMatrixRain();
    player.interactionCooldown = 20;
    if (type === 'minion') {
        activeBattleEnemy = { type: 'minion', name: 'MINOR BUG', hp: 50, maxHp: 50, spriteKey: 'bug', minionIndex: index, lvl: 5 };
        battleMsg = "A wild BUG appeared!";
    } else {
        activeBattleEnemy = { type: 'boss', name: 'THE GLITCH', hp: 200, maxHp: 200, spriteKey: 'glitch', minionIndex: -1, lvl: 50 };
        battleMsg = "THE GLITCH wants to battle!";
    }
}
function updateBattle() {
    if (battleShake > 0) battleShake *= 0.9; if (battleShake < 0.5) battleShake = 0;
    for (let i = battleEffects.length - 1; i >= 0; i--) {
        let p = battleEffects[i]; p.x += p.vx; p.y += p.vy; p.life--;
        if (p.life <= 0) battleEffects.splice(i, 1);
    }
    
    if (battleState === 'FAINT_ANIM') {
       return; 
    }
    if (battleState === 'MENU') {
        if (player.interactionCooldown > 0) player.interactionCooldown--;
        // Use keyProcessed check for menu navigation to prevent rapid firing
        if (keys.ArrowUp && !keyProcessed.ArrowUp && player.interactionCooldown === 0) { 
            keyProcessed.ArrowUp = true;
            battleMenuIdx = Math.max(0, battleMenuIdx - 1); 
            player.interactionCooldown = 5; 
            playSound('SELECT'); 
        }
        if (keys.ArrowDown && !keyProcessed.ArrowDown && player.interactionCooldown === 0) { 
            keyProcessed.ArrowDown = true;
            battleMenuIdx = Math.min(2, battleMenuIdx + 1); 
            player.interactionCooldown = 5; 
            playSound('SELECT'); 
        }
        if (keys[" "] && !keyProcessed[" "] && player.interactionCooldown === 0) { 
            keyProcessed[" "] = true;
            player.interactionCooldown = 20; 
            selectBattleAction(battleMenuIdx); 
        }
    } else if (battleState === 'QUESTION') {
        if (player.interactionCooldown > 0) player.interactionCooldown--;
        if (keys.ArrowUp && !keyProcessed.ArrowUp && player.interactionCooldown === 0) { 
            keyProcessed.ArrowUp = true;
            selectedOptionIdx = Math.max(0, selectedOptionIdx - 1); 
            player.interactionCooldown = 5; 
            playSound('SELECT'); 
        }
        if (keys.ArrowDown && !keyProcessed.ArrowDown && player.interactionCooldown === 0) { 
            keyProcessed.ArrowDown = true;
            selectedOptionIdx = Math.min(2, selectedOptionIdx + 1); 
            player.interactionCooldown = 5; 
            playSound('SELECT'); 
        }
        if (keys[" "] && !keyProcessed[" "] && player.interactionCooldown === 0) { 
            keyProcessed[" "] = true;
            player.interactionCooldown = 20; 
            checkAnswer(); 
        }
    }
    
    if (battleState === 'VICTORY_WAIT') {
        if (keys[" "] && !keyProcessed[" "] && player.interactionCooldown === 0) {
             keyProcessed[" "] = true;
             player.hp = Math.min(player.maxHp, player.hp + 10); 
             if (activeBattleEnemy.type === 'minion') {
                activeMinions[activeBattleEnemy.minionIndex].active = false;
                currentState = STATE.ROAM; 
                player.interactionCooldown = 30; 
                // Only play chapel music if in chapel, otherwise return to roam
                if (player.currentRoom === 'CHAPEL') playMusic('CHAPEL');
                else playMusic('ROAM');
            } else winGame();
        }
        if (player.interactionCooldown > 0) player.interactionCooldown--;
    }
}
function selectBattleAction(idx) {
    if (idx === 1) { 
        pendingAction = 'AI'; 
        battleMsg = "Used AI Shortcut..."; 
        battleState = 'BUSY'; // LOCK INPUT
        setTimeout(executeAction, 1000); 
    } else if (idx === 2) { // RUN
        battleMsg = "Got away safely!";
        battleState = 'BUSY';
        setTimeout(() => {
             currentState = STATE.ROAM;
             player.interactionCooldown = 30;
             // Only play chapel music if in chapel, otherwise return to roam
             if (player.currentRoom === 'CHAPEL') playMusic('CHAPEL');
             else playMusic('ROAM');
        }, 1000);
    } else {
        // idx 0 (QUESTION)
        pendingAction = 'DRAFT';
        currentQuestion = getNextQuestion(); // Use the pool system instead of raw random
        selectedOptionIdx = 0;
        battleState = 'QUESTION';
    }
}
function checkAnswer() {
    const isCorrect = selectedOptionIdx === currentQuestion.correct;
    if (isCorrect) { 
        battleMsg = "It's super effective!"; 
        playSound('CORRECT'); 
        battleState = 'BUSY'; // LOCK INPUT
        setTimeout(executeAction, 1000); 
    } else {
        battleMsg = "It wasn't very effective..."; 
        playSound('WRONG');
        battleState = 'ANIMATION';
        setTimeout(() => {
            player.hp -= 20; battleShake = 20;
            battleEffects.push({x: 150, y: 300, vx:0, vy:-2, life:60, type:'text', text:'-20', color:'#f44'});
            if(player.hp <= 0) loseGame("You blacked out!"); else endPlayerTurn();
        }, 1000);
    }
}
function executeAction() {
    battleState = 'ANIMATION';
    let dmg = 0;
    if (pendingAction === 'DRAFT') {
        dmg = 30 + Math.floor(Math.random()*10);
        battleMsg = "Player used CRITICAL THINKING!";
        battleEffects.push({x: 200, y: 350, targetX: 550, targetY: 150, vx: 10, vy: -5, life: 40, type: 'projectile', icon: ' 📄 '});
        setTimeout(() => hitEnemy(dmg), 500);
    } else if (pendingAction === 'AI') {
        dmg = 60; player.auth -= 30;
        battleMsg = "INCORRECT INFO! AI HALLUCINATED!";
        battleEffects.push({x: 200, y: 350, targetX: 550, targetY: 150, vx: 10, vy: -5, life: 40, type: 'projectile', icon: ' 🤖 '});
        setTimeout(() => {
             player.hp -= 10;
             battleEffects.push({x: 150, y: 300, vx:0, vy:-2, life:60, type:'text', text:'-10', color:'#f44'});
             hitEnemy(dmg);
        }, 500);
    }
}
function hitEnemy(dmg) {
    activeBattleEnemy.hp -= dmg;
    battleEffects.push({x: 550, y: 100, vx:0, vy:-2, life:60, type:'text', text:dmg, color:'#fff'});
    battleShake = 10; playSound('HIT');
    
    if (activeBattleEnemy.hp <= 0) {
        playEnemyDownSfx(); 
        battleState = 'FAINT_ANIM';
        setTimeout(() => {
            stopAllMusic(); // Stop battle music
            playVictoryFanfare(); // Celebration fanfare
            battleMsg = `${activeBattleEnemy.name} was destroyed!`;
            // Start victory music after fanfare finishes
            setTimeout(() => {
                playMusic('WIN'); // Start victory music loop
            }, 1200); // Wait for fanfare to play
            setTimeout(() => {
                battleMsg = "You gained 50 EXP & HP!";
                playSound('CORRECT');
                battleState = 'VICTORY_WAIT';
                player.interactionCooldown = 20;
            }, 1500);
        }, 1000);
    } else if (player.auth <= 0) loseGame("Disqualified for Malpractice!");
    else setTimeout(endPlayerTurn, 1000);
}
function endPlayerTurn() {
    battleState = 'ENEMY_TURN';
    battleMsg = `${activeBattleEnemy.name} used HALLUCINATION!`;
    setTimeout(enemyAttack, 1500);
}
function enemyAttack() {
    let dmg = 10 + Math.floor(Math.random()*10);
    if (activeBattleEnemy.type === 'minion') dmg = 5;
    battleEffects.push({x: 550, y: 150, targetX: 200, targetY: 350, vx: -10, vy: 5, life: 40, type: 'projectile', spriteKey: 'bug'});
    setTimeout(() => {
        player.hp -= dmg; playSound('HIT');
        battleEffects.push({x: 150, y: 300, vx:0, vy:-2, life:60, type:'text', text:`-${dmg}`, color:'#f44'});
        battleShake = 10;
        if (player.hp <= 0) loseGame("You blacked out!");
        else { battleState = 'MENU'; battleMsg = "What will PLAYER do?"; player.interactionCooldown = 10; }
    }, 500);
}
function winGame() { 
    // Mark boss as defeated in the map data (not just local reference)
    if (MAP_LAYOUTS['OFFICE'].boss) {
        MAP_LAYOUTS['OFFICE'].boss.active = false;
    }
    if (activeBoss) {
        activeBoss.active = false;
    }
    currentState = STATE.WIN; 
    winTimer = 0; // Reset timer
    playMusic('WIN'); 
}
function loseGame(reason) { currentState = STATE.GAMEOVER; battleMsg = reason; playMusic('NONE'); }
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (currentState === STATE.TRANSITION) {
        drawMapScreen();
        const p = 1 - (transitionTimer / 90); 
        const shutterHeight = (canvas.height / 2) * p;
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, shutterHeight); 
        ctx.fillRect(0, canvas.height - shutterHeight, canvas.width, shutterHeight); 
        if (transitionTimer % 4 < 2) {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        return;
    }
    if (currentState === STATE.BATTLE) { drawBattle(); return; }
    if (currentState === STATE.WIN || currentState === STATE.GAMEOVER) { drawEndScreen(); return; }
    drawMapScreen();
}
function drawMapScreen() {
    ctx.fillStyle = activeRoom.color || COLORS.floor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    for (let y = 0; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
            const tile = activeMap[y][x];
            if (tile === 1) {
                ctx.fillStyle = COLORS.wall;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                ctx.strokeStyle = '#222';
                ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            } else if (tile === 2) { // Door
                drawSprite(ctx, 'door', x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, true);
            } else if (tile === 3) { // Table
                drawSprite(ctx, 'table', x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, true);
            } else if (tile === 4) { // Chair
                drawSprite(ctx, 'chair', x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, true);
            } else if (tile === 5) { // Plant
                drawSprite(ctx, 'plant', x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, true);
            } else if (tile === 6) { // Altar/Counter
                drawSprite(ctx, 'table', x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, true);
            }
        }
    }
    ctx.textAlign = 'center';
    
    // Draw Crowd
    activeCrowd.forEach(c => {
         const drawX = (c.pixelX !== undefined) ? c.pixelX : c.gridX * TILE_SIZE;
         const drawY = (c.pixelY !== undefined) ? c.pixelY : c.gridY * TILE_SIZE;
         const bob = c.isMoving ? (frames / 5) : 0; 
         drawSprite(ctx, c.spriteKey, drawX, drawY, TILE_SIZE, c.facingRight, bob);
    });
    activeMinions.forEach(m => { 
        if(m.active) drawSprite(ctx, m.spriteKey, m.gridX * TILE_SIZE, m.gridY * TILE_SIZE, TILE_SIZE, true); 
    });
    
    activeNPCs.forEach(npc => {
        const drawX = (npc.pixelX !== undefined) ? npc.pixelX : npc.gridX * TILE_SIZE;
        const drawY = (npc.pixelY !== undefined) ? npc.pixelY : npc.gridY * TILE_SIZE;
        const bob = npc.isMoving ? (frames / 5) : 0; 
        
        drawSprite(ctx, npc.spriteKey, drawX, drawY, TILE_SIZE, false, bob);
        
        if (npc.id === 'grant_final' && activeBoss && !activeBoss.active) {
           drawSprite(ctx, 'alert', npc.gridX * TILE_SIZE, (npc.gridY - 1) * TILE_SIZE, TILE_SIZE, false);
        }
    });
    if (activeBoss && activeBoss.active) { 
        drawSprite(ctx, activeBoss.spriteKey, activeBoss.gridX * TILE_SIZE, activeBoss.gridY * TILE_SIZE, 50, false); 
    }
    drawSprite(ctx, player.spriteKey, player.x, player.y, TILE_SIZE, player.facingRight, player.isMoving ? player.bobFrame : 0);
    ctx.fillStyle = '#fff'; ctx.textAlign = 'left'; ctx.font = '12px "Press Start 2P"';
    ctx.fillText(`HP: ${player.hp}`, 10, 20); 
}
function drawHealthBox(x, y, name, lvl, hp, maxHp, showNumbers) {
    // Box Body
    ctx.fillStyle = '#fff'; ctx.strokeStyle='#000'; ctx.lineWidth=3;
    ctx.fillRect(x, y, 300, 80); ctx.strokeRect(x, y, 300, 80);
    
    // Text
    ctx.fillStyle = '#000'; ctx.font = '14px "Press Start 2P"'; ctx.textAlign = 'left';
    ctx.fillText(name, x + 10, y + 30);
    ctx.fillText("Lv" + lvl, x + 220, y + 30);
    // HP Bar
    ctx.fillStyle = '#555'; ctx.fillRect(x + 60, y + 45, 200, 15); // Back
    const pct = Math.max(0, hp / maxHp);
    ctx.fillStyle = pct > 0.5 ? '#4f4' : (pct > 0.2 ? '#fd0' : '#f44');
    ctx.fillRect(x + 60, y + 45, 200 * pct, 15); // Front
    
    ctx.fillStyle = '#000'; ctx.font = '10px "Press Start 2P"'; ctx.fillText("HP", x + 30, y + 57);
    
    if (showNumbers) {
        ctx.fillText(`${Math.floor(hp)}/ ${maxHp}`, x + 150, y + 70);
    }
}
function drawEndScreen() {
    ctx.fillStyle = currentState === STATE.WIN ? '#000' : '#200'; ctx.fillRect(0,0,800,600);
    ctx.textAlign = 'center'; 
    
    if (currentState === STATE.WIN) {
        ctx.font = '30px "Press Start 2P"';
        ctx.fillStyle = '#44ff44';
        ctx.fillText("INTEGRITY RESTORED!", 400, 60);

        ctx.font = '14px "Press Start 2P"';
        ctx.fillStyle = '#ffffff';
        ctx.fillText("Great job! You have purged the glitches.", 400, 110);
        
        ctx.fillStyle = '#f0db4f';
        ctx.fillText("REMEMBER THE AI CODE:", 400, 160);
        
        ctx.textAlign = 'left';
        ctx.fillStyle = '#ffffff';
        ctx.fillText("1. AUTHENTICITY: Your work must be your own.", 80, 210);
        ctx.fillText("2. TRANSPARENCY: Reference AI tools used.", 80, 250);
        ctx.fillText("3. VERIFICATION: Check AI facts.", 80, 290);
        ctx.fillText("4. CONSEQUENCES: Misuse = Disqualification.", 80, 330);
        
        ctx.textAlign = 'center';
        ctx.fillStyle = '#cccccc';
        ctx.fillText("Use AI as a tool, not a replacement.", 400, 380); 
        
        ctx.fillStyle = '#ffffff';
        ctx.fillText("Press SPACE to Restart", 400, 560);

        // Mr Clinton Pop-up (10 seconds = 600 frames at 60fps)
        if (winTimer > 600) {
            // Draw Box
            ctx.fillStyle = '#333';
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 4;
            ctx.fillRect(150, 420, 500, 100);
            ctx.strokeRect(150, 420, 500, 100);
            
            // Draw Clinton
            drawSprite(ctx, 'clinton', 170, 440, 60, false);
            
            // Draw Text
            ctx.fillStyle = '#fff';
            ctx.textAlign = 'left';
            ctx.font = '12px "Press Start 2P"';
            ctx.fillText("Mr Clinton:", 250, 450);
            wrapText(ctx, "\"You did a really really brilliant job!\"", 250, 480, 380, 20);
        }

    } else {
        ctx.fillStyle = '#f44';
        ctx.font = '30px "Press Start 2P"';
        ctx.fillText("GAME OVER", 400, 250);
        ctx.fillStyle = '#fff'; ctx.font = '14px "Press Start 2P"';
        ctx.fillText(battleMsg, 400, 320);
        ctx.fillText("Press SPACE to restart.", 400, 450);
    }
}
window.addEventListener('keydown', e => { if ((currentState === STATE.WIN || currentState === STATE.GAMEOVER) && e.key === " ") location.reload(); });
function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
